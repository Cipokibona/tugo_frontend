<div class="container-fluid background min-vh-100 p-3">

  <div class="d-flex align-items-center mb-3">
    <button
      class="btn btn-light btn-sm rounded-circle me-2"
      (click)="goBack()"
    >
      <i class="fa fa-arrow-left"></i>
    </button>
    <h5 class="fw-bold mb-0">Ride details</h5>
  </div>

  <div class="card border-0 shadow-sm rounded-4 p-3 mb-3 blackOrWhite">
    <div class="mb-2 d-flex align-items-center gap-2">
      <span class="fw-bold">{{ ride?.from_city }}</span>
      <i class="fas fa-arrow-right"></i>
      <span class="fw-bold">{{ ride?.to_city }}</span>
      @if(isProposedRide()) {
        <span class="badge text-bg-warning">PROPOSED</span>
      }
    </div>

    <div class="row small text-muted">
      <div class="col-6">
        <i class="bi bi-calendar"></i> {{ ride?.departure_date | date:'dd MMM yyyy' }}
      </div>
      <div class="col-6">
        <i class="bi bi-clock"></i> {{ ride?.departure_time }}
      </div>
      <div class="col-6 mt-2">
        <i class="bi bi-geo-alt"></i>
        {{ ride?.distance_km ? (ride.distance_km + ' km') : 'Distance inconnue' }}
      </div>
      <div class="col-6 mt-2">
        <i class="bi bi-people"></i>
        @if(isProposedRide()) {
          {{ joinedUsersCount }} joined
        } @else {
          {{ ((ride?.available_seats || 0) - (bookings.length || 0)) }} seats left
        }
      </div>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-4 p-3 mb-3 blackOrWhite">
    <div class="d-flex align-items-center">
      <div class="avatar me-3">
        {{ (isProposedRide() ? (ride?.proposer_username || ride?.driver_username) : ride?.driver_username)?.charAt(0)?.toUpperCase() }}
      </div>
      <div class="flex-grow-1">
        <div class="fw-semibold">
          {{ isProposedRide() ? (ride?.proposer_username || 'Proposer') : ride?.driver_username }}
        </div>
        <div class="text-muted small">
          @if(isProposedRide()) {
            Proposal creator
          } @else {
            Rating {{ ride?.drive_rating }}
          }
        </div>
      </div>
      <a [routerLink]="['/chat', ride?.id]" class="btn btn-outline-info btn-sm rounded-pill">
        <i class="fa fa-comment mx-1"></i>
        <span class="fw-bold">Chat</span>
      </a>
    </div>
  </div>

  <div class="card border-0 shadow-sm rounded-4 p-3 mb-3 blackOrWhite">
    <h6 class="fw-semibold mb-2">Additional info</h6>
    <p class="small text-muted mb-1">
      <strong>Car model:</strong>
      {{ ride?.vehicule || 'Not specified' }}
    </p>
    <p class="small text-muted mb-0">
      {{ ride?.note || 'No additional information provided.' }}
    </p>

    @if(isDriver()) {
      <hr>

      <p class="small mb-1">
        <strong>Bookings:</strong> {{ bookings.length || 0 }} in {{ ride?.available_seats || 0 }} seats
      </p>

      <p class="small mb-3">
        <strong>Total earned:</strong>
        {{ ((bookings.length || 0) * (ride?.price || 0)) | number:'1.2-2' }} BIF
      </p>

      @if(ride?.status === 'CANCELLED') {
        <span class="badge text-bg-danger">Ride cancelled</span>
      } @else {
        <button
          class="btn btn-outline-danger rounded-pill px-4"
          [disabled]="cancellingRide"
          (click)="cancelRide()"
        >
          @if(!cancellingRide) {
            Cancel ride
          } @else {
            <i class="spinner-border spinner-border-sm me-2"></i>
            Cancelling...
          }
        </button>
      }
    }
  </div>

  @if(errorMessage) {
    <div class="alert alert-danger py-2 small">{{ errorMessage }}</div>
  }

  @let seatsLeft = ((ride?.available_seats || 0) - (bookings.length || 0));

  @if(!isDriver() && !isProposer()) {
    <div class="card border-0 shadow-sm rounded-4 p-3 mb-3 blackOrWhite">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">

        @if(!isProposedRide()) {
          <div class="flex-grow-1 min-w-100 min-w-sm-auto">
            <div class="small text-muted">Price / seat</div>
            <div class="fw-bold fs-5 principal">
              {{ prixFinal(ride?.price) | number:'1.2-2' }} BIF
            </div>
          </div>

          <div class="d-flex align-items-center gap-2 flex-grow-1 min-w-100 min-w-sm-auto">
            <span class="small text-muted">Seats:</span>
            <select class="form-select form-select-sm w-auto" [(ngModel)]="selectedSeats">
              @for (n of [].constructor(seatsLeft); track $index) {
                <option [value]="$index + 1">{{ $index + 1 }}</option>
              }
            </select>
          </div>

          <div class="flex-grow-1 min-w-100 min-w-sm-auto">
            <div class="small text-muted">Total</div>
            <div class="fw-bold">
              {{ ((selectedSeats || 1) * (prixFinal(ride?.price) || 0)) | number:'1.2-2' }} BIF
            </div>
          </div>
        } @else {
          <div class="flex-grow-1 min-w-100 min-w-sm-auto">
            <div class="small text-muted">Joined users</div>
            <div class="fw-bold fs-5 principal">{{ joinedUsersCount }}</div>
          </div>

          <div class="w-100"></div>

          <div class="d-flex align-items-center gap-2">
            <span class="small text-muted">Join as:</span>
            <button
              type="button"
              class="btn btn-sm rounded-pill px-3"
              [class.principal]="proposedJoinRole === 'CLIENT'"
              [class.btn-outline-secondary]="proposedJoinRole !== 'CLIENT'"
              (click)="setProposedJoinRole('CLIENT')"
            >
              Client
            </button>
            <button
              type="button"
              class="btn btn-sm rounded-pill px-3"
              [class.principal]="proposedJoinRole === 'DRIVER'"
              [class.btn-outline-secondary]="proposedJoinRole !== 'DRIVER'"
              (click)="setProposedJoinRole('DRIVER')"
            >
              Driver
            </button>
          </div>

          @if(proposedJoinRole === 'DRIVER') {
            <div class="d-flex align-items-center gap-2">
              <span class="small text-muted">Available seats:</span>
              <input
                type="number"
                min="1"
                class="form-control form-control-sm w-auto"
                [(ngModel)]="proposedDriverSeats"
              >
            </div>
          }
        }

        <small class="text-warning">
          @if(isProposedRide()) {
            Join this proposal to show your interest in this trip.
          } @else {
            You can cancel your booking only 30 minutes before departure.
          }
        </small>

        @if(userBookedSeatsCount > 0) {
          <small class="text-muted">
            @if(isProposedRide()) {
              You have joined this proposal.
            } @else {
              You have booked <strong>{{ userBookedSeatsCount }}</strong> seat(s) on this ride.
            }
          </small>
        }

        <div class="d-flex gap-2 flex-grow-1 min-w-100 min-w-sm-auto">
          @if(!(isProposedRide() && proposedJoinRole === 'DRIVER')) {
            <button
              class="btn btn-outline-secondary rounded-pill px-4"
              [disabled]="userBookedSeatsCount === 0 || cancellingBooking"
              (click)="cancelMyBookings()"
            >
              @if(!cancellingBooking) {
                @if(isProposedRide()) {
                  Cancel join
                } @else {
                  Cancel booking
                }
              } @else {
                <i class="spinner-border spinner-border-sm me-2"></i>
                Cancelling...
              }
            </button>
          }

          <button
            class="btn button principal rounded-pill px-4"
            [disabled]="
              (isProposedRide() && proposedJoinRole === 'CLIENT' && hasJoinedRide()) ||
              (isProposedRide() && proposedJoinRole === 'DRIVER' && proposedDriverSeats <= 0) ||
              (!isProposedRide() && (seatsLeft <= 0 || !selectedSeats))
            "
            (click)="bookRide()"
          >
            @if(!loadingBooking) {
              @if(isProposedRide()) {
                @if(proposedJoinRole === 'DRIVER') {
                  Create ride from proposal
                } @else {
                  Join
                }
              } @else {
                Book now
              }
            }

            @if(loadingBooking) {
              <i class="spinner-border spinner-border-sm me-2"></i>
              Processing...
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>

@if(showInvoice) {
  <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content rounded-4 p-4">

        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="d-flex align-items-center">
            <img src="/logo_tugo.svg" alt="Tugo" style="width: 4rem; height:auto;" class="me-3">
            <h5 class="modal-title fw-bold mb-0">Invoice</h5>
          </div>
          <div class="text-muted small">
            Date: {{ today | date:'dd MMM yyyy, HH:mm' }}
          </div>
          <button type="button" class="btn-close ms-3" (click)="goHome()"></button>
        </div>

        <hr>

        <div class="modal-body">
          <div class="row mb-2">
            <div class="col-6">
              <strong>Passenger:</strong> {{ invoiceData.passenger }}
            </div>
            <div class="col-6">
              <strong>Seats reserved:</strong> {{ invoiceData.seats }}
            </div>
          </div>

          <div class="row mb-2">
            <div class="col-6">
              <strong>Ride:</strong> {{ invoiceData.ride.from_city }} -> {{ invoiceData.ride.to_city }}
            </div>
            <div class="col-6">
              <strong>Departure:</strong> {{ invoiceData.ride.departure_date | date:'dd MMM yyyy' }} at {{ invoiceData.ride.departure_time }}
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-6">
              <strong>Price / seat:</strong> {{ invoiceData.pricePerSeat | number:'1.2-2' }} BIF
            </div>
            <div class="col-6 text-end">
              <strong class="fs-5 principal">Total: {{ invoiceData.total | number:'1.2-2' }} BIF</strong>
            </div>
          </div>

          <div class="alert alert-warning small text-center mb-3">
            Please be on time for your ride.<br>
            Thank you for choosing Tugo!
          </div>

        </div>

        <hr>

        <div class="modal-footer border-0 justify-content-between">
          <button class="btn btn-outline-secondary rounded-pill px-4" (click)="goHome()">
            Close
          </button>

          <button class="btn button principal rounded-pill px-4" (click)="downloadInvoice()">
            <i class="fa fa-download me-2"></i> Download PDF
          </button>
        </div>

      </div>
    </div>
  </div>
}
